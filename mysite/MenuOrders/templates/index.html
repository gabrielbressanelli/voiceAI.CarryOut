<!DOCTYPE html>
<html>
    <head>
        <title> Menu Webpage </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
        rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
        crossorigin="anonymous">

        <script   src="https://code.jquery.com/jquery-3.7.1.min.js"   
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="   
        crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

        <!-- Bootstrap JS (including Popper.js) -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <style>
            .fixed-size-img {
                width: 100%; /* Make it fill the width of the card */
                height: 200px; /* Set a fixed height */
                object-fit: cover; /* Crop the image to fit the box */
            }
            .card-spacing {
                margin-right: 30px; /* Add extra spacing between the cards */
            } 

            .nav-under-modal {
              z-index: 900;
            }

        </style>

    </head>

    <body>
        {% include 'navbar.html' %}
      
        <div class="container">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }}">
                {{ message }}
                <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
      
          <h2>Appetizers</h2>
          <div class="row">
            {% for item in appetizer %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
      
          <br>
      
          <h2>Pasta</h2>
          <div class="row">
            {% for item in pasta %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
      
          <br>
      
          <h2>Grill</h2>
          <div class="row">
            {% for item in grill %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
      
          <br>

          <h2>Saute</h2>
          <div class="row">
            {% for item in saute %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
      
          <br>
      
          <h2>Seafood</h2>
          <div class="row">
            {% for item in seafood %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
      
          <br>
      
          <h2>Dessert</h2>
          <div class="row">
            {% for item in dessert %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
        </div>
      
        <!-- Modifiers modal -->
        <div class="modal fade" id="modifierModal" tabindex="-1" aria-labelledby="modifierModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modifierModalLabel">Choose Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="modifierModalBody"></div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="modifierCancelBtn" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-secondary d-none" id="modifierSkipBtn">Skip add-ons</button>
                <button type="button" class="btn btn-primary" id="modifierConfirmBtn" disabled>Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </body>
      <script>
        // function to refresh pill count
        async function refreshCartQtyOnly() {
            try {
                const res = await fetch("{% url 'cart_count'}?t=" + Date.now(), {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin', 
                });
                if (!res.ok) return;
                const { cart_qty } = await res.json();
                if (typeof cart_qty !== 'undefined') setCartQty(cart_qty)
            } catch (_) {}
            
        }
        // --- CSRF helper (Django default cookie name is "csrftoken")
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
        }
        const csrftoken = getCookie('csrftoken');

        function computeModalState(groups) {
          const requiredGroups = groups.filter(g => !!(g.required));
          const isGloballyOptional = requiredGroups.length === 0;

          // Count selections per group id
          const selectedByGroup = {};
          document.querySelectorAll('.modifier-group').forEach(grp => {
            const gid = grp.getAttribute('data-group-id');
            selectedByGroup[gid] = grp.querySelectorAll('.modifier-option:checked').length;
          });

          const allRequiredSatisfied = requiredGroups.every(g => {
            const gid = (g.group_id ?? g.id);
            return (selectedByGroup[String(gid)] || 0) >= 1; // min=1 when required
          });

          const anySelected = Object.values(selectedByGroup).some(n => n > 0);

          return { isGloballyOptional, allRequiredSatisfied, anySelected };
        }

        function applyFooterUI({ isGloballyOptional, allRequiredSatisfied, anySelected }) {
          const $confirm = $('#modifierConfirmBtn');
          const $cancel  = $('#modifierCancelBtn');
          const $skip    = $('#modifierSkipBtn');

          if (isGloballyOptional) {
            // Show Skip + Add selected (disabled until any selected)
            $cancel.addClass('d-none');
            $skip.removeClass('d-none');
            $confirm.text('Add selected');
            $confirm.prop('disabled', !anySelected);
          } else {
            // Show Cancel + Continue (disabled until required satisfied)
            $skip.addClass('d-none');
            $cancel.removeClass('d-none');
            $confirm.text('Continue');
            $confirm.prop('disabled', !allRequiredSatisfied);
          }
        }

        function refreshFooter(groups) {
          applyFooterUI(computeModalState(groups));
        }
      
        // --- Modal builder
        function showModifierModal(menuId, groups, onConfirm) {
          const $body = $('#modifierModalBody');
          $body.empty();

          groups.forEach((group, idx) => {
            const gId       = group.group_id ?? group.id ?? idx;
            const gName     = group.group_name ?? group.name ?? 'Options';
            const required  = !!group.required;
            const maxChoice = Number(group.max_choices ?? 0);
            const opts      = Array.isArray(group.options) ? group.options : [];

            const single    = (maxChoice === 1);
            const inputType = single ? 'radio' : 'checkbox';
            const nameAttr  = `group_${gId}`;
            const hasDefault = opts.some(o => !!o.is_default);

            const html = `
              <div class="mb-4 modifier-group" data-group-id="${gId}" data-max-choices="${maxChoice}">
                <h6>${gName}${required ? '<span class="text-danger">*</span>' : ''}</h6>
                <div>
                  ${opts.map((opt, i) => {
                    const price = Number(opt.price_delta ?? opt.price ?? 0);
                    const plus  = price ? ` (+$${price.toFixed(2)})` : '';
                    const deflt = !!opt.is_default;
                    const check = single && !hasDefault && i === 0 ? 'checked' : (deflt ? 'checked' : '');
                    return `
                      <div class="form-check">
                        <input class="form-check-input modifier-option"
                              type="${inputType}"
                              name="${nameAttr}"
                              value="${opt.id}"
                              data-option-id="${opt.id}"
                              data-group-id="${gId}"
                              id="option_${gId}_${opt.id}"
                              ${check}>
                        <label class="form-check-label" for="option_${gId}_${opt.id}">
                          ${opt.name}${plus}
                        </label>
                      </div>`;
                  }).join('')}
                </div>
                ${maxChoice > 0 ? `<div class="form-text">Choose up to ${maxChoice}.</div>` : ''}
              </div>`;
            $body.append(html);

            if (single && required) {
              const $grp = $(`.modifier-group[data-group-id="${gId}"]`);
              if (!$grp.find('.modifier-option:checked').length) {
                $grp.find('.modifier-option').first().prop('checked', true);
              }
            }
          });

          // Enforce limits and refresh UI on any change
          $(document).off('change.modifier').on('change.modifier', '.modifier-option', function () {
            const $opt   = $(this);
            const gId    = $opt.data('groupId');
            const $grp   = $(`.modifier-group[data-group-id="${gId}"]`);
            const max    = Number($grp.data('maxChoices')) || 0;
            const $all   = $grp.find('.modifier-option');

            if (max === 1) {
              if ($opt.is(':checked')) $all.not($opt).prop('checked', false);
            } else if (max > 0) {
              const $checked = $all.filter(':checked');
              if ($checked.length > max) {
                $opt.prop('checked', false);
                window.toastr?.info?.(`Choose up to ${max}.`);
              }
            }
            refreshFooter(groups);
          });

          // Show the modal
          const modalEl = document.getElementById('modifierModal');
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();

          // Initial footer state
          refreshFooter(groups);

          // Confirm (single binding; remove duplicates)
          $('#modifierConfirmBtn').off('click.mod').on('click.mod', function () {
            // Guard (in case user enabled button via DOM hacking)
            const { isGloballyOptional, allRequiredSatisfied, anySelected } = computeModalState(groups);
            if (!isGloballyOptional && !allRequiredSatisfied) return;

            const selectedIds = [];
            $('.modifier-option:checked').each(function () {
              selectedIds.push(Number(this.value));
            });
            modal.hide();
            onConfirm(selectedIds);
          });

          // Skip add-ons (only shown when all optional)
          $('#modifierSkipBtn').off('click.mod').on('click.mod', function () {
            const { isGloballyOptional } = computeModalState(groups);
            if (!isGloballyOptional) return; // safety
            modal.hide();
            onConfirm([]); // explicit “no add-ons”
          });
        }
      
        // --- Utilities
        async function refreshCartSummary() {
          try {
            const res = await fetch('{% url "cart:cart_summary" %}', {
              method: 'GET',
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const html = await res.text();
            const $body = $('#offcanvasRight .offcanvas-body');
            if ($body.length) $body.html(html);
          } catch (e) {
            console.error('Failed to refresh cart summary:', e);
            window.toastr?.error?.('Failed to update cart display.');
          }
        }

        // INITIAL POPULATE
        document.addEventListener('DOMContentLoaded', () => {
            refreshCartSummary();
        });
      
        function setCartQty(qty) {
          // Faster and avoids selector typos:
          const el = document.getElementById('cart_quantity'); 
          if (!el) return;

          const n = Math.max(0, Number(qty) || 0); // coerce & clamp
          el.textContent = n;
          // optional niceties:
          el.classList.toggle('invisible', n <= 0);
          el.setAttribute('aria-label', `Cart items: ${n}`);
        }
      
        // --- Main bind block (single source of truth)
        $(document).ready(function () {
      
          // ADD to cart (delegated)
          $(document).on('click', '.add-cart', function (e) {
            e.preventDefault();
      
            const $btn   = $(this);
            const menuId = $btn.data('item-id');
            const addUrl = $btn.data('cart-add-url');
            const modsUrl = $btn.data('modifiers-url') || `/${menuId}/modifiers/`;
            const $card  = $btn.closest('.card');
      
            if (!menuId || !addUrl) {
              console.error('Missing item id or add url');
              return;
            }
      
            let qty = 1;
            const $qtySelect = $card.find('select[data-role="qty"], select.qty-cart');
            if ($qtySelect.length) qty = Math.max(1, Number($qtySelect.val() || 1));
            const note = ($card.find('[name="note"]').val() || '').toString();
      
            $btn.prop('disabled', true);
      
            $.getJSON(modsUrl, function (payload) {
              const groups = Array.isArray(payload) ? payload : (payload.groups || []);
              if (!groups.length) {
                return addToCartAjax(addUrl, menuId, qty, [], note, $btn);
              }
              showModifierModal(menuId, groups, function onConfirm(selectedIds) {
                addToCartAjax(addUrl, menuId, qty, selectedIds, note, $btn);
              });
            }).fail(function (xhr) {
              console.error('Failed to load modifiers:', xhr.status, xhr.responseText);
              // Graceful fallback: add without options
              addToCartAjax(addUrl, menuId, qty, [], note, $btn);
            });
          });
      
          function addToCartAjax(addUrl, menuId, qty, selectedOptionIds, note, $btn) {
            $.ajax({
              type: 'POST',
              url: addUrl,
              headers: { 'X-CSRFToken': csrftoken },
              dataType: 'json',
              data: {
                menu_id: menuId,
                qty: qty,
                note: note,
                'modifier_options_ids[]': selectedOptionIds
              }
            }).done(async function (json) {
              if (json?.ok) {
                if (typeof json.cart_qty !== 'undefined') setCartQty(json.cart_qty);
                await refreshCartSummary();
                window.toastr?.success?.('Item added to cart!');
                //location.reload();
              } else {
                window.toastr?.error?.(json?.error || 'Could not add item.');
              }
            }).fail(function (xhr) {
              console.error('ADD error', xhr.status, xhr.responseText);
              window.toastr?.error?.('Add to cart failed.');
            }).always(function () {
              $btn.prop('disabled', false);
            });
          }
      
          // UPDATE line quantity in cart (delegated)
          $(document).on('click', '.update-line', function (e) {
            e.preventDefault();
            const idx = $(this).data('index');
            const newQty = $(`select.cart-update-qty[data-line-index="${idx}"]`).val();
            $.ajax({
                type: 'POST',
                url: "{% url 'cart:cart_update' %}",
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                dataType: 'json',
                data: { action: 'post', line_index: idx, item_qty: newQty },
            }).done(async (json) => {
                if (json?.ok) await refreshCartSummary();
                await refreshCartQtyOnly();
                sessionStorage.setItem('keepOffcanvasOpen', 'true');
                location.reload();
            }).fail(xhr => console.error('UPDATE error', xhr.status, xhr.responseText));
            });
      
          // DELETE a line (delegated)
          $(document).on('click', '.delete-line', function (e) {
            e.preventDefault();
            const idx = $(this).data('index');

            $.ajax({
              type: 'POST',
              url: "{% url 'cart:cart_delete' %}",
              headers: { 'X-CSRFToken': '{{ csrf_token }}' },
              dataType: 'json',
              data: { action: 'post', line_index: idx },
            })
            .done(async (json) => {
              if (!json || json.ok !== true) {
                console.warn('Delete returned not-ok JSON:', json);
                window.toastr?.warning?.('Could not remove item. Try again.');
                return;
              }

              // 1) Update the pill immediately from the server-confirmed count
              if (typeof json.cart_qty !== 'undefined') setCartQty(json.cart_qty);

              // 2) Refresh summary and re-validate count in parallel
              await Promise.all([
                refreshCartSummary(),
                refreshCartQtyOnly(),
              ]);

              // 3) Keep offcanvas open (your existing behavior)
              sessionStorage.setItem('keepOffcanvasOpen', 'true');
            })
            .fail(xhr => {
              console.error('DELETE error', xhr.status, xhr.responseText);
              window.toastr?.error?.('Delete failed.');
            })
          });
          // modal over fixed navbar
          const nav = document.querySelector('.navbar')

          document.addEventListener('show.bs.modal', () => {
              nav?.classList.add('nav-under-modal');
            });
            document.addEventListener('hidden.bs.modal', () => {
              nav?.classList.remove('nav-under-modal');
            });
        });// <-- closes document.ready (only once)
      </script>
</html>