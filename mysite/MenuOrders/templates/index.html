<!DOCTYPE html>
<html>
    <head>
        <title> Menu Webpage </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
        rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
        crossorigin="anonymous">

        <script   src="https://code.jquery.com/jquery-3.7.1.min.js"   
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="   
        crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

        <!-- Bootstrap JS (including Popper.js) -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <style>
            .fixed-size-img {
                width: 100%; /* Make it fill the width of the card */
                height: 200px; /* Set a fixed height */
                object-fit: cover; /* Crop the image to fit the box */
            }
            .card-spacing {
                margin-right: 30px; /* Add extra spacing between the cards */
            } 

        </style>

    </head>

    <body>
        {% include 'navbar.html' %}
      
        <div class="container">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }}">
                {{ message }}
                <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
      
          <h2>Appetizers</h2>
          <div class="row">
            {% for item in appetizer %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
      
          <br>
      
          <h2>Pasta</h2>
          <div class="row">
            {% for item in pasta %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
      
          <br>
      
          <h2>Grill</h2>
          <div class="row">
            {% for item in grill %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
      
          <br>
      
          <h2>Seafood</h2>
          <div class="row">
            {% for item in seafood %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
      
          <br>
      
          <h2>Dessert</h2>
          <div class="row">
            {% for item in dessert %}
              {% include "partials/_menu_card.html" %}
            {% endfor %}
          </div>
        </div>
      
        <!-- Modifiers modal -->
        <div class="modal fade" id="modifierModal" tabindex="-1" aria-labelledby="modifierModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modifierModalLabel">Choose Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="modifierModalBody"></div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="modifierConfirmBtn">Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </body>
      <script>
        // function to refresh pill count
        async function refreshCartQtyOnly() {
            try {
                const res = await fetch("{% url 'cart_count'}?t=" + Date.now(), {
                    headers: { 'X-Requested-with': 'XMLHttpRequest' }
                });
                if (!res.ok) return;
                const { cart_qty } = await res.json();
                if (typeof cart_qty !== 'undefined') setCartQty(cart_qty)
            } catch (_) {}
            
        }
        // --- CSRF helper (Django default cookie name is "csrftoken")
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
        }
        const csrftoken = getCookie('csrftoken');
      
        // --- Modal builder
        function showModifierModal(menuId, groups, onConfirm) {
          const $body = $('#modifierModalBody');
          $body.empty();
      
          groups.forEach((group) => {
            const gName = group.group_name ?? group.name ?? 'Options';
            const required = !!group.required;
            const opts = group.options || [];
      
            const html = `
              <div class="mb-4">
                <h6>${gName}${required ? '<span class="text-danger">*</span>' : ''}</h6>
                <div>
                  ${opts.map(opt => {
                    const price = (opt.price_delta ?? opt.price) || 0;
                    const plus = price ? ` (+$${Number(price).toFixed(2)})` : '';
                    return `
                      <div class="form-check">
                        <input class="form-check-input modifier-option" type="checkbox"
                               value="${opt.id}" data-option-id="${opt.id}" id="option_${opt.id}">
                        <label class="form-check-label" for="option_${opt.id}">
                          ${opt.name}${plus}
                        </label>
                      </div>`;
                  }).join('')}
                </div>
              </div>`;
            $body.append(html);
          });
      
          const modal = new bootstrap.Modal(document.getElementById('modifierModal'));
          modal.show();
      
          $('#modifierConfirmBtn').off('click').on('click', function () {
            const selectedIds = [];
            $('.modifier-option:checked').each(function () {
              selectedIds.push(Number($(this).val()));
            });
            modal.hide();
            onConfirm(selectedIds);
          });
        }
      
        // --- Utilities
        async function refreshCartSummary() {
          try {
            const res = await fetch('{% url "cart:cart_summary" %}', {
              method: 'GET',
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const html = await res.text();
            const $body = $('#offcanvasRight .offcanvas-body');
            if ($body.length) $body.html(html);
          } catch (e) {
            console.error('Failed to refresh cart summary:', e);
            window.toastr?.error?.('Failed to update cart display.');
          }
        }

        // INITIAL POPULATE
        document.addEventListener('DOMContentLoaded', () => {
            refreshCartSummary();
        });
      
        function setCartQty(qty) {
          const el = document.querySelector('cart_quantity');
          if (el != null && qty != null) el.textContent = qty;
        }
      
        // --- Main bind block (single source of truth)
        $(document).ready(function () {
      
          // ADD to cart (delegated)
          $(document).on('click', '.add-cart', function (e) {
            e.preventDefault();
      
            const $btn   = $(this);
            const menuId = $btn.data('item-id');
            const addUrl = $btn.data('cart-add-url');
            const modsUrl = $btn.data('modifiers-url') || `/${menuId}/modifiers/`;
            const $card  = $btn.closest('.card');
      
            if (!menuId || !addUrl) {
              console.error('Missing item id or add url');
              return;
            }
      
            let qty = 1;
            const $qtySelect = $card.find('select[data-role="qty"], select.qty-cart');
            if ($qtySelect.length) qty = Math.max(1, Number($qtySelect.val() || 1));
            const note = ($card.find('[name="note"]').val() || '').toString();
      
            $btn.prop('disabled', true);
      
            $.getJSON(modsUrl, function (payload) {
              const groups = Array.isArray(payload) ? payload : (payload.groups || []);
              if (!groups.length) {
                return addToCartAjax(addUrl, menuId, qty, [], note, $btn);
              }
              showModifierModal(menuId, groups, function onConfirm(selectedIds) {
                addToCartAjax(addUrl, menuId, qty, selectedIds, note, $btn);
              });
            }).fail(function (xhr) {
              console.error('Failed to load modifiers:', xhr.status, xhr.responseText);
              // Graceful fallback: add without options
              addToCartAjax(addUrl, menuId, qty, [], note, $btn);
            });
          });
      
          function addToCartAjax(addUrl, menuId, qty, selectedOptionIds, note, $btn) {
            $.ajax({
              type: 'POST',
              url: addUrl,
              headers: { 'X-CSRFToken': csrftoken },
              dataType: 'json',
              data: {
                menu_id: menuId,
                qty: qty,
                note: note,
                'modifier_options_ids[]': selectedOptionIds
              }
            }).done(async function (json) {
              if (json?.ok) {
                if (typeof json.cart_qty !== 'undefined') setCartQty(json.cart_qty);
                await refreshCartSummary();
                window.toastr?.success?.('Item added to cart!');
                location.reload();
              } else {
                window.toastr?.error?.(json?.error || 'Could not add item.');
              }
            }).fail(function (xhr) {
              console.error('ADD error', xhr.status, xhr.responseText);
              window.toastr?.error?.('Add to cart failed.');
            }).always(function () {
              $btn.prop('disabled', false);
            });
          }
      
          // UPDATE line quantity in cart (delegated)
          $(document).on('click', '.update-line', function (e) {
            e.preventDefault();
            const idx = $(this).data('index');
            const newQty = $(`select.cart-update-qty[data-line-index="${idx}"]`).val();
            $.ajax({
                type: 'POST',
                url: "{% url 'cart:cart_update' %}",
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                dataType: 'json',
                data: { action: 'post', line_index: idx, item_qty: newQty },
            }).done(async (json) => {
                if (json?.ok) await refreshCartSummary();
                await refreshCartQtyOnly();
                sessionStorage.setItem('keepOffcanvasOpen', 'true');
                location.reload();
            }).fail(xhr => console.error('UPDATE error', xhr.status, xhr.responseText));
            });
      
          // DELETE a line (delegated)
          $(document).on('click', '.delete-line', function (e) {
                e.preventDefault();
                const idx = $(this).data('index');
                $.ajax({
                    type: 'POST',
                    url: "{% url 'cart:cart_delete' %}",
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    dataType: 'json',
                    data: { action: 'post', line_index: idx },
                }).done(async (json) => {
                    if (json?.ok) await refreshCartSummary();
                    await refreshCartQtyOnly();
                    // location.reload();
                }).fail(xhr => console.error('DELETE error', xhr.status, xhr.responseText));
            });
        }); // <-- closes document.ready (only once)
      </script>

</html>