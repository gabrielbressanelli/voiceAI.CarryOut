<!DOCTYPE html>
<html>
    <head>
        <title> Menu Webpage </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
        rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
        crossorigin="anonymous">

        <script   src="https://code.jquery.com/jquery-3.7.1.min.js"   
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="   
        crossorigin="anonymous"></script>

        <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

        <!-- Bootstrap JS (including Popper.js) -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <style>
            .fixed-size-img {
                width: 100%; /* Make it fill the width of the card */
                height: 200px; /* Set a fixed height */
                object-fit: cover; /* Crop the image to fit the box */
            }
            .card-spacing {
                margin-right: 30px; /* Add extra spacing between the cards */
            } 

        </style>

    </head>

    <body>
        {% include 'navbar.html' %}

        <div class="container">
            <div class="row">
                <div class="col-md-6 offset-md-2">
                    <br>
                        <br>
                        <div class="card">
                            <div class="card-header">
                                <h4>Order Summary </h4>
                            </div>
                            <div class="card-body" id="delivery_order_summary">
                                {% for L in lines %}
                                  <p>
                                    {{ L.name }} : {{ L.unit_price }}<br>
                                    <small>Quantity: {{ L.qty }}</small>
                                    {% if L.options and L.options|length %}
                                      <br><small>Options:
                                        {% for opt in L.options %}
                                          {{ opt.name }} 
                                          {% if opt.price_delta and opt.price_delta != "0.00"%}
                                          (+${{ opt.price_delta }})
                                          {% endif %}
                                          {% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                      </small>
                                    {% endif %}
                                    {% if L.note %}<br><small>Note: {{ L.note }}</small>{% endif %}
                                  </p>
                                {% empty %}
                                  <p>Your cart is empty.</p>
                                {% endfor %}
                              
                                <hr>
                                <p><strong>Total: {{ totals }}</strong></p>
                              </div>
                        </div>
                        <br><br>
                        <!-- <div class="card">
                            <div class="card-header">
                                <h4>Costumer Information </h4>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{% url 'billing_info' %}">
                                    {% csrf_token %}
                                    {{form.as_p}}
                            </div>
                        </div> -->
                        <br>
                            <div align="center">
                                <button id="pay-btn" class="btn btn-primary">
                                    Proceed to Payment
                                </button>
                            </div>
                                </form>

                    <br><br>
                </div>
            </div>
        </div>


    </body>

    <script>
      function resetPayBtn() {
        const btn = document.getElementById('pay-btn');
        if (btn) { btn.disabled = false; btn.textContent = 'Proceed to Payment'; }
      }
      window.addEventListener('pageshow', resetPayBtn);
      
      // ---------- CSRF helper ----------
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }
      const csrftoken = getCookie('csrftoken');

      // ---------- Cart pill updater ----------
      function setCartQty(qty) {
        const el = document.getElementById('cart_quantity');
        if (!el) return;
        const n = Math.max(0, Number(qty) || 0);
        el.textContent = n;
        el.classList.toggle('invisible', n <= 0);
        el.setAttribute('aria-label', `Cart items: ${n}`);
      }

      // ---------- Fetch the current cart count ----------
      async function refreshCartQtyOnly() {
        try {
          const res = await fetch("{% url 'cart:cart_count' %}?t=" + Date.now(), {
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin',
          });
          if (!res.ok) return;
          const { cart_qty } = await res.json();
          if (typeof cart_qty !== 'undefined') setCartQty(cart_qty);
        } catch (_) {}
      }

      // ---------- Load the offcanvas cart fragment ----------
      async function refreshCartSummary() {
        try {
          const res = await fetch("{% url 'cart:cart_summary' %}?t=" + Date.now(), {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin',
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const html = await res.text();
          const $body = $('#offcanvasRight .offcanvas-body');
          if ($body.length) $body.html(html);
        } catch (e) {
          console.error('Failed to refresh cart summary:', e);
          window.toastr?.error?.('Failed to update cart display.');
        }
      }

      // ---------- Update quantity (delegated; survives re-renders) ----------
      $(document).on('click', '.update-line', function (e) {
        e.preventDefault();
        const idx = $(this).data('index');
        const newQty = $(`select.cart-update-qty[data-line-index="${idx}"]`).val();
        $.ajax({
          type: 'POST',
          url: "{% url 'cart:cart_update' %}",
          headers: { 'X-CSRFToken': csrftoken },
          dataType: 'json',
          data: { action: 'post', line_index: idx, item_qty: newQty },
        })
        .done(async (json) => {
          if (json?.ok) {
            await Promise.all([refreshCartSummary(), refreshCartQtyOnly()]);
            locaion.reload()
            sessionStorage.setItem('keepOffcanvasOpen', 'true');
          } else {
            window.toastr?.warning?.('Could not update item.');
          }
        })
        .fail(xhr => console.error('UPDATE error', xhr.status, xhr.responseText));
      });

      // ---------- Delete a line (delegated) ----------
      $(document).on('click', '.delete-line', function (e) {
        e.preventDefault();
        const idx = $(this).data('index');

        $.ajax({
          type: 'POST',
          url: "{% url 'cart:cart_delete' %}",
          headers: { 'X-CSRFToken': csrftoken },
          dataType: 'json',
          data: { action: 'post', line_index: idx },
        })
        .done(async (json) => {
          if (!json || json.ok !== true) {
            console.warn('Delete returned not-ok JSON:', json);
            window.toastr?.warning?.('Could not remove item. Try again.');
            return;
          }
          if (typeof json.cart_qty !== 'undefined') setCartQty(json.cart_qty); // instant pill update
          await Promise.all([refreshCartSummary(), refreshCartQtyOnly()]);
          //sessionStorage.setItem('keepOffcanvasOpen', 'true');
          location.reload();
        })
        .fail(xhr => {
          console.error('DELETE error', xhr.status, xhr.responseText);
          window.toastr?.error?.('Delete failed.');
        });
      });

      // ---------- Start checkout (Stripe) ----------
      document.getElementById("pay-btn").addEventListener("click", async (e) => {
        const btn = e.currentTarget;
        btn.disabled = true; btn.textContent = "Redirectingâ€¦";
        try {
          const r = await fetch("/payment/create-checkout-session/", {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin',
          });
          const { checkout_url, error } = await r.json();
          if (error) throw new Error(error);
          window.location.href = checkout_url;
        } catch (err) {
          alert("Could not start payment. Please try again.");
          btn.disabled = false; btn.textContent = "Proceed to Payment";
        }
      });

    </script>

</html>